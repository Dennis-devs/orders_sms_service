- name: Setup SMS Service
  hosts: localhost
  become: false
  vars:
    app_path: "{{ playbook_dir }}/../orders_sms_service"  # /github/workspace/ in CI
  tasks:
    - name: Ensure Python is installed
      raw: which python3 || apt-get update && apt-get install -y python3 python3-pip
      changed_when: false
    - name: Install requirements
      pip:
        requirements: "{{ app_path }}/requirements.txt"
        executable: "{{ ansible_python_interpreter | default('pip3') }}"  # Use virtualenv pip
    - name: Run Django migrations
      command: "{{ ansible_python_interpreter | default('python3') }} {{ app_path }}/manage.py migrate"
      environment:
        PYTHONPATH: "{{ app_path }}:{{ app_path }}/orders_sms_service/"
        DJANGO_SECRET_KEY: "{{ lookup('env', 'DJANGO_SECRET_KEY') }}"
        DATABASE_URL: "sqlite:///:memory:"
        AFRICASTALKING_USERNAME: "sandbox"
        AFRICASTALKING_API_KEY: "{{ lookup('env', 'AFRICASTALKING_API_KEY') }}"
        OIDC_CLIENT_ID: "test-id"
        OIDC_CLIENT_SECRET: "test-secret"
        
        